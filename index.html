<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EDU-GeoTrack</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (to interpret JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- App Icon / Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%232563eb'/><path d='M35 65 L45 35 L55 35 L65 65' stroke='white' stroke-width='8' fill='none' stroke-linecap='round'/><circle cx='50' cy='25' r='8' fill='white'/></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' style='background-color: %232563eb'><rect width='100' height='100' fill='%232563eb'/><path d='M30 70 L40 30 L60 30 L70 70' stroke='white' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/><circle cx='50' cy='20' r='10' fill='white'/></svg>">

    <style>
        body { overscroll-behavior: none; }
        .leaflet-control-attribution { font-size: 8px; background: rgba(255,255,255,0.7); padding: 0 4px; border-radius: 4px; }
        .leaflet-control-layers { border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: none; font-family: sans-serif; font-weight: 600; }
        .leaflet-touch .leaflet-control-layers-toggle { width: 44px; height: 44px; }
        .leaflet-control-zoom { border: none !important; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1) !important; }
        .leaflet-control-zoom a { border-radius: 8px !important; width: 40px !important; height: 40px !important; line-height: 40px !important; font-size: 18px !important; color: #333 !important; margin-bottom: 5px !important; background: white !important; }
        
        .leaflet-popup-content-wrapper { border-radius: 12px; font-family: sans-serif; font-size: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .leaflet-popup-content { margin: 12px; text-align: center; line-height: 1.4; }
        
        /* Pulse Animation for Heart */
        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.3); }
            28% { transform: scale(1); }
            42% { transform: scale(1.3); }
            70% { transform: scale(1); }
        }
        .animate-heartbeat {
            animation: heartbeat 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, className, size = 24, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const AppLogo = () => (
            <svg width="32" height="32" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" rx="20" fill="#EFF6FF"/>
                <path d="M30 70L45 25L55 25L70 70" stroke="#2563EB" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round"/>
                <path d="M25 45L40 45" stroke="#F97316" strokeWidth="8" strokeLinecap="round"/>
                <path d="M60 55L75 55" stroke="#F97316" strokeWidth="8" strokeLinecap="round"/>
                <circle cx="50" cy="18" r="8" fill="#2563EB"/>
            </svg>
        );

        const Icons = {
            Play: (props) => <Icon {...props} path={<polygon points="5 3 19 12 5 21 5 3"></polygon>} fill="currentColor" />,
            Pause: (props) => <Icon {...props} path={<><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>} fill="currentColor" />,
            Square: (props) => <Icon {...props} path={<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>} fill="currentColor" />,
            Navigation: (props) => <Icon {...props} path={<polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>} />,
            Clock: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} />,
            Activity: (props) => <Icon {...props} path={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>} />,
            RotateCcw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></>} />,
            History: (props) => <Icon {...props} path={<path d="M3 3v5h5M3.05 13A9 9 0 1 0 6 5.3L3 8"></path>} />,
            Heart: (props) => <Icon {...props} path={<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>} fill={props.filled ? "currentColor" : "none"} />,
            Map: (props) => <Icon {...props} path={<polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>} />,
            Clipboard: (props) => <Icon {...props} path={<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>} />
        };

        const getDistanceFromLatLonInMeters = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };

        const UNILAG_COORDS = [6.515768, 3.389917];

        function App() {
            // Tabs: 'tracker' | 'history'
            const [activeTab, setActiveTab] = useState('tracker');
            
            // Tracker State
            const [isActive, setIsActive] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [path, setPath] = useState([]);
            const [distance, setDistance] = useState(0);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [currentSpeed, setCurrentSpeed] = useState(0);
            const [heartRate, setHeartRate] = useState(72);
            const [demoMode, setDemoMode] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);

            // History State
            const [runHistory, setRunHistory] = useState([]);
            const [vitals, setVitals] = useState({ ldl: '', hdl: '', note: '' });

            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const polylineRef = useRef(null); // The glow
            const polylineInnerRef = useRef(null); // The sharp line
            const markerRef = useRef(null);
            const watchIdRef = useRef(null);
            const demoIntervalRef = useRef(null);
            const pauseMarkersRef = useRef([]);

            const formatTime = (totalSeconds) => {
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };

            const formatDistance = (meters) => {
                if (meters < 1000) {
                    return { value: Math.round(meters), unit: 'm' };
                }
                return { value: (meters / 1000).toFixed(2), unit: 'km' };
            };

            // Reverse Geocoding Function (Get Street Name)
            const getStreetName = async (lat, lng) => {
                try {
                    // Using OSM Nominatim - strictly limited use, good for demos/low volume.
                    // User-Agent is good practice.
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
                    const response = await fetch(url, {
                        headers: { 'User-Agent': 'EDU-GeoTrack-App' }
                    });
                    const data = await response.json();
                    
                    // Construct a nice address
                    if (data && data.address) {
                        const road = data.address.road || data.address.pedestrian || data.address.suburb || "";
                        const area = data.address.city || data.address.town || data.address.county || "";
                        if (road) return `${road}, ${area}`;
                        if (data.display_name) return data.display_name.split(',')[0];
                    }
                    return "Unknown Location";
                } catch (e) {
                    console.error("Geocoding error", e);
                    return "Location Unavailable";
                }
            };

            // Load History on Mount
            useEffect(() => {
                const savedHistory = localStorage.getItem('eduGeoTrack_history');
                if (savedHistory) setRunHistory(JSON.parse(savedHistory));

                const savedVitals = localStorage.getItem('eduGeoTrack_vitals');
                if (savedVitals) setVitals(JSON.parse(savedVitals));
            }, []);

            const saveVitals = () => {
                localStorage.setItem('eduGeoTrack_vitals', JSON.stringify(vitals));
                alert("Health vitals saved!");
            };

            // Map Initialization
            useEffect(() => {
                if (activeTab === 'tracker' && !mapInstanceRef.current && document.getElementById('map-container')) {
                    // Initialize map with zoom controls ENABLED now
                    const map = L.map('map-container', { 
                        zoomControl: false // We will add it manually to position it better
                    }).setView(UNILAG_COORDS, 16);
                    
                    // Add Zoom Control to Bottom Right
                    L.control.zoom({ position: 'bottomright' }).addTo(map);

                    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OSM',
                        maxZoom: 19
                    });

                    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri',
                        maxZoom: 18
                    });

                    satelliteLayer.addTo(map);

                    const baseMaps = {
                        "Satellite": satelliteLayer,
                        "Map": streetLayer
                    };
                    L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

                    mapInstanceRef.current = map;
                    
                    if (path.length > 0) {
                         // Re-draw path if returning from another tab
                         polylineRef.current = L.polyline(path, { color: '#F97316', weight: 8, opacity: 0.4 }).addTo(map); // Glow
                         polylineInnerRef.current = L.polyline(path, { color: '#FFFFFF', weight: 3, opacity: 1 }).addTo(map); // Sharp inner
                         
                         const lastPoint = path[path.length - 1];
                         const runnerIcon = L.divIcon({
                            html: `<div style="background-color: #F97316; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px #F97316;"></div>`,
                            className: 'custom-runner-icon',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        markerRef.current = L.marker(lastPoint, { icon: runnerIcon }).addTo(map);
                        map.setView(lastPoint, 17);
                    } else {
                        map.locate({ setView: true, maxZoom: 17, enableHighAccuracy: true });
                    }

                    map.on('locationfound', (e) => {
                        if (path.length === 0 && !markerRef.current) {
                            const runnerIcon = L.divIcon({
                                html: `<div style="background-color: #f97316; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px #F97316;"></div>`,
                                className: 'custom-runner-icon',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });
                            markerRef.current = L.marker(e.latlng, { icon: runnerIcon }).addTo(map);
                        }
                    });
                }
            }, [activeTab]);

            // Timer & Heart Rate
            useEffect(() => {
                let interval = null;
                if (isActive && !isPaused) {
                    interval = setInterval(() => {
                        setElapsedTime(p => p + 1);
                        const randomFluctuation = Math.floor(Math.random() * 5) - 2; 
                        setHeartRate(prev => {
                            let target = 135; 
                            if (currentSpeed < 2) target = 100;
                            if (currentSpeed > 10) target = 160;
                            const diff = target - prev;
                            return prev + (diff * 0.1) + randomFluctuation;
                        });
                    }, 1000);
                } else {
                    clearInterval(interval);
                    if(isPaused && heartRate > 80) {
                         const dropInterval = setInterval(() => {
                             setHeartRate(h => Math.max(75, h - 1));
                         }, 1000);
                         return () => clearInterval(dropInterval);
                    }
                }
                return () => clearInterval(interval);
            }, [isActive, isPaused, currentSpeed]);

            // GPS Logic with ACCURACY FILTER
            useEffect(() => {
                if (isActive && !isPaused && !demoMode && navigator.geolocation) {
                    watchIdRef.current = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude, speed, accuracy } = position.coords;
                            // Filter: If accuracy is very bad (>50m), ignore it to avoid spikes
                            if (accuracy && accuracy > 50) return;
                            
                            updatePath([latitude, longitude], speed);
                        },
                        (err) => setErrorMsg(err.message),
                        { enableHighAccuracy: true, distanceFilter: 5 }
                    );
                } else {
                    if (watchIdRef.current) navigator.geolocation.clearWatch(watchIdRef.current);
                }
                return () => { if (watchIdRef.current) navigator.geolocation.clearWatch(watchIdRef.current); };
            }, [isActive, isPaused, demoMode]);

            // Demo Mode
            useEffect(() => {
                if (isActive && !isPaused && demoMode && activeTab === 'tracker') {
                    if (!mapInstanceRef.current) return;

                    let lat = path.length > 0 ? path[path.length - 1][0] : UNILAG_COORDS[0];
                    let lng = path.length > 0 ? path[path.length - 1][1] : UNILAG_COORDS[1];
                    
                    if (path.length === 0) {
                         mapInstanceRef.current.setView(UNILAG_COORDS, 17);
                    }

                    let angle = (path.length * 0.1); 

                    demoIntervalRef.current = setInterval(() => {
                        angle += 0.08;
                        // Smoothing the curve slightly for visual appeal
                        lat += (Math.sin(angle) * 0.00015) + (Math.random() * 0.00002);
                        lng += (Math.cos(angle) * 0.00015) + (Math.random() * 0.00002);
                        updatePath([lat, lng], 3.2); 
                    }, 1000);
                } else {
                    clearInterval(demoIntervalRef.current);
                }
                return () => clearInterval(demoIntervalRef.current);
            }, [isActive, isPaused, demoMode, activeTab]);

            const updatePath = (newPoint, speedMPS) => {
                setPath((prevPath) => {
                    const updatedPath = [...prevPath, newPoint];
                    if (prevPath.length > 0) {
                        const lastPoint = prevPath[prevPath.length - 1];
                        const distAdded = getDistanceFromLatLonInMeters(lastPoint[0], lastPoint[1], newPoint[0], newPoint[1]);
                        setDistance((d) => d + distAdded);
                    }

                    if (mapInstanceRef.current) {
                        // Drawing Smart Realistic Lines (Glow Effect)
                        // Layer 1: The Glow
                        if (!polylineRef.current) {
                            polylineRef.current = L.polyline(updatedPath, { color: '#F97316', weight: 8, opacity: 0.4, lineCap: 'round' }).addTo(mapInstanceRef.current);
                        } else {
                            polylineRef.current.setLatLngs(updatedPath);
                        }

                        // Layer 2: The Core Line (Sharp)
                        if (!polylineInnerRef.current) {
                            polylineInnerRef.current = L.polyline(updatedPath, { color: '#FFFFFF', weight: 3, opacity: 1, lineCap: 'round' }).addTo(mapInstanceRef.current);
                        } else {
                            polylineInnerRef.current.setLatLngs(updatedPath);
                        }

                        if (markerRef.current) {
                            markerRef.current.setLatLng(newPoint);
                        } else {
                            const runnerIcon = L.divIcon({
                                html: `<div style="background-color: #F97316; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px #F97316;"></div>`,
                                className: 'custom-runner-icon',
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });
                            markerRef.current = L.marker(newPoint, { icon: runnerIcon }).addTo(mapInstanceRef.current);
                        }
                        mapInstanceRef.current.panTo(newPoint, { animate: true });
                    }

                    let currentSpeedKmh = 0;
                    if (speedMPS !== null && speedMPS !== undefined) {
                        currentSpeedKmh = speedMPS * 3.6;
                    } 
                    setCurrentSpeed(currentSpeedKmh);
                    return updatedPath;
                });
            };

            const handleStart = () => { setIsActive(true); setIsPaused(false); };
            
            // --- NEW: Handle Pause with Geocoding ---
            const handlePause = async () => {
                setIsPaused(true);
                if (path.length > 0 && mapInstanceRef.current) {
                    const lastPoint = path[path.length - 1];
                    const distDisplay = formatDistance(distance);
                    
                    // Create marker first
                    const pauseMarker = L.marker(lastPoint, {
                        icon: L.divIcon({
                            html: `<div style="background-color: #eab308; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.4);">||</div>`,
                            className: 'pause-marker-icon',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).addTo(mapInstanceRef.current);

                    // Show temporary loading state
                    pauseMarker.bindPopup(`
                        <div style="text-align:center;">
                            <strong style="color:#eab308; text-transform:uppercase;">Paused</strong><br/>
                            <span class="text-xs text-gray-400">Locating street...</span><br/>
                            <span style="font-size:14px; font-weight:bold;">${distDisplay.value} ${distDisplay.unit}</span>
                        </div>
                    `).openPopup();
                    pauseMarkersRef.current.push(pauseMarker);

                    // Fetch Street Name (Async)
                    const streetName = await getStreetName(lastPoint[0], lastPoint[1]);
                    
                    // Update Popup with real street name
                    pauseMarker.setPopupContent(`
                        <div style="text-align:center;">
                            <strong style="color:#eab308; text-transform:uppercase;">Paused</strong><br/>
                            <span style="font-size:11px; color:#374151; font-weight:600; display:block; margin:4px 0;">üìç ${streetName}</span>
                            <span style="font-size:14px; font-weight:bold;">${distDisplay.value} ${distDisplay.unit}</span><br/>
                            <span style="color:#666; font-size:10px;">${formatTime(elapsedTime)}</span>
                        </div>
                    `);
                }
            };

            const handleStop = () => { 
                setIsActive(false); 
                setIsPaused(false); 
                
                if (distance > 10) { 
                    const newRun = {
                        id: Date.now(),
                        date: new Date().toLocaleDateString(),
                        timestamp: new Date().toLocaleTimeString(),
                        distance: distance,
                        duration: elapsedTime,
                        avgSpeed: (distance / elapsedTime) * 3.6 || 0
                    };
                    const updatedHistory = [newRun, ...runHistory];
                    setRunHistory(updatedHistory);
                    localStorage.setItem('eduGeoTrack_history', JSON.stringify(updatedHistory));
                }

                if (mapInstanceRef.current && polylineRef.current) {
                    const bounds = polylineRef.current.getBounds();
                    if(bounds.isValid()) mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50] });
                }
            };

            const handleReset = () => {
                setIsActive(false);
                setIsPaused(false);
                setPath([]);
                setDistance(0);
                setElapsedTime(0);
                setCurrentSpeed(0);
                setHeartRate(72);
                if (polylineRef.current) {
                    polylineRef.current.remove();
                    polylineRef.current = null;
                }
                if (polylineInnerRef.current) {
                    polylineInnerRef.current.remove();
                    polylineInnerRef.current = null;
                }
                pauseMarkersRef.current.forEach(m => m.remove());
                pauseMarkersRef.current = [];
            };

            const clearHistory = () => {
                if(confirm("Delete all history?")) {
                    setRunHistory([]);
                    localStorage.removeItem('eduGeoTrack_history');
                }
            };

            const mainDistDisplay = formatDistance(distance);

            // --- UI RENDER ---
            return (
                <div className="flex flex-col h-screen bg-gray-50 font-sans">
                    {/* Header */}
                    <header className="bg-white shadow-sm px-4 py-3 z-20">
                        <div className="flex justify-between items-center max-w-lg mx-auto">
                            <div className="flex items-center gap-2">
                                <AppLogo />
                                <h1 className="text-xl font-bold text-gray-800 tracking-tight">EDU-GeoTrack</h1>
                            </div>
                            
                            {activeTab === 'tracker' && (
                                <button 
                                    onClick={() => { if(!isActive) setDemoMode(!demoMode) }}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none ${demoMode ? 'bg-blue-600' : 'bg-gray-200'} ${isActive ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                                >
                                    <span className={`${demoMode ? 'translate-x-6' : 'translate-x-1'} inline-block h-4 w-4 transform rounded-full bg-white transition`}/>
                                </button>
                            )}
                        </div>
                    </header>

                    {/* Content Area */}
                    <main className="flex-1 relative overflow-hidden flex flex-col">
                        
                        {/* TRACKER TAB */}
                        <div className={`flex-1 flex flex-col relative ${activeTab === 'tracker' ? 'flex' : 'hidden'}`}>
                             {/* Map */}
                             <div className="flex-1 relative bg-gray-900">
                                 <div id="map-container" className="absolute inset-0 z-0" style={{ outline: 'none' }}></div>
                                 {errorMsg && (
                                    <div className="absolute top-4 left-4 right-4 z-[400] bg-red-100 border-l-4 border-red-500 text-red-700 p-3 text-sm rounded shadow-lg flex justify-between items-center">
                                        <p>{errorMsg}</p>
                                        <button onClick={() => setErrorMsg(null)} className="font-bold">‚úï</button>
                                    </div>
                                 )}
                             </div>

                             {/* Tracker Stats Panel */}
                             <div className="bg-white border-t border-gray-200 p-4 pb-20 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-10 rounded-t-3xl">
                                <div className="max-w-lg mx-auto">
                                    {/* Primary Stats */}
                                    <div className="grid grid-cols-4 gap-2 mb-6 text-center">
                                        {/* Distance */}
                                        <div className="flex flex-col items-center p-2 bg-blue-50 rounded-xl">
                                            <Icons.Navigation size={16} className="text-blue-600 mb-1" />
                                            <div className="text-lg font-black text-gray-800 leading-tight">
                                                {mainDistDisplay.value}
                                            </div>
                                            <span className="text-[10px] font-bold text-gray-400 uppercase">{mainDistDisplay.unit}</span>
                                        </div>

                                        {/* Time */}
                                        <div className="flex flex-col items-center p-2 bg-orange-50 rounded-xl">
                                            <Icons.Clock size={16} className="text-orange-600 mb-1" />
                                            <div className="text-lg font-black text-gray-800 leading-tight font-mono">
                                                {formatTime(elapsedTime)}
                                            </div>
                                            <span className="text-[10px] font-bold text-gray-400 uppercase">Time</span>
                                        </div>

                                        {/* Pace */}
                                        <div className="flex flex-col items-center p-2 bg-green-50 rounded-xl">
                                            <Icons.Activity size={16} className="text-green-600 mb-1" />
                                            <div className="text-lg font-black text-gray-800 leading-tight">
                                                {currentSpeed.toFixed(1)}
                                            </div>
                                            <span className="text-[10px] font-bold text-gray-400 uppercase">km/h</span>
                                        </div>

                                        {/* Heart Rate (New) */}
                                        <div className="flex flex-col items-center p-2 bg-red-50 rounded-xl">
                                            <Icons.Heart size={16} className={`text-red-500 mb-1 ${isActive && !isPaused ? 'animate-heartbeat' : ''}`} filled={true} />
                                            <div className="text-lg font-black text-gray-800 leading-tight">
                                                {Math.round(heartRate)}
                                            </div>
                                            <span className="text-[10px] font-bold text-gray-400 uppercase">BPM</span>
                                        </div>
                                    </div>

                                    {/* Controls */}
                                    <div className="flex items-center justify-center gap-4">
                                        {!isActive ? (
                                            <button onClick={handleStart} className="flex-1 py-3 bg-blue-600 active:bg-blue-700 text-white rounded-xl flex items-center justify-center gap-2 font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">
                                                <Icons.Play size={20} /> Start
                                            </button>
                                        ) : (
                                            <>
                                                {!isPaused ? (
                                                    <button onClick={handlePause} className="flex-1 py-3 bg-yellow-500 active:bg-yellow-600 text-white rounded-xl flex items-center justify-center gap-2 font-bold shadow-lg shadow-yellow-200 transition-all active:scale-95">
                                                        <Icons.Pause size={20} /> Pause
                                                    </button>
                                                ) : (
                                                    <button onClick={handleStart} className="flex-1 py-3 bg-blue-600 active:bg-blue-700 text-white rounded-xl flex items-center justify-center gap-2 font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">
                                                        <Icons.Play size={20} /> Resume
                                                    </button>
                                                )}
                                                <button onClick={handleStop} className="w-16 py-3 bg-red-100 text-red-600 active:bg-red-200 rounded-xl flex items-center justify-center transition-colors">
                                                    <Icons.Square size={20} />
                                                </button>
                                            </>
                                        )}
                                        {!isActive && distance > 0 && (
                                            <button onClick={handleReset} className="w-12 py-3 bg-gray-100 text-gray-500 active:bg-gray-200 rounded-xl flex items-center justify-center">
                                                <Icons.RotateCcw size={18} />
                                            </button>
                                        )}
                                    </div>
                                    
                                    {demoMode && <p className="text-center text-[10px] text-gray-400 mt-2">*Simulation Mode Active</p>}
                                </div>
                             </div>
                        </div>

                        {/* HISTORY TAB */}
                        <div className={`flex-1 flex-col bg-gray-50 overflow-y-auto pb-24 ${activeTab === 'history' ? 'flex' : 'hidden'}`}>
                            <div className="p-4 max-w-lg mx-auto w-full space-y-6">
                                
                                {/* Health Vitals Section */}
                                <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
                                    <div className="flex items-center gap-2 mb-4">
                                        <div className="bg-red-100 p-2 rounded-lg text-red-500">
                                            <Icons.Heart filled={true} size={20}/>
                                        </div>
                                        <h2 className="text-lg font-bold text-gray-800">My Vitals</h2>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="text-xs font-semibold text-gray-500 uppercase">LDL Cholesterol</label>
                                            <div className="relative mt-1">
                                                <input 
                                                    type="number" 
                                                    placeholder="100"
                                                    value={vitals.ldl}
                                                    onChange={(e) => setVitals({...vitals, ldl: e.target.value})}
                                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 pl-3 text-sm focus:outline-none focus:border-blue-500 transition-colors"
                                                />
                                                <span className="absolute right-3 top-2 text-xs text-gray-400">mg/dL</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs font-semibold text-gray-500 uppercase">HDL Cholesterol</label>
                                            <div className="relative mt-1">
                                                <input 
                                                    type="number" 
                                                    placeholder="60"
                                                    value={vitals.hdl}
                                                    onChange={(e) => setVitals({...vitals, hdl: e.target.value})}
                                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 pl-3 text-sm focus:outline-none focus:border-blue-500 transition-colors"
                                                />
                                                <span className="absolute right-3 top-2 text-xs text-gray-400">mg/dL</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={saveVitals} className="w-full py-2 bg-gray-900 text-white text-sm font-semibold rounded-lg hover:bg-black transition-colors">
                                        Save Health Profile
                                    </button>
                                </div>

                                {/* Daily Track List */}
                                <div>
                                    <div className="flex justify-between items-end mb-3">
                                        <h2 className="text-lg font-bold text-gray-800">Daily Track</h2>
                                        {runHistory.length > 0 && (
                                            <button onClick={clearHistory} className="text-xs text-red-500 font-semibold px-2 py-1 rounded hover:bg-red-50">
                                                Clear All
                                            </button>
                                        )}
                                    </div>

                                    <div className="space-y-3">
                                        {runHistory.length === 0 ? (
                                            <div className="text-center py-10 bg-white rounded-2xl border border-dashed border-gray-300">
                                                <div className="text-gray-300 mb-2">
                                                    <Icons.Clipboard size={40} className="mx-auto" />
                                                </div>
                                                <p className="text-gray-500 font-medium text-sm">No runs recorded yet.</p>
                                                <p className="text-gray-400 text-xs">Start running to track your history!</p>
                                            </div>
                                        ) : (
                                            runHistory.map((run) => {
                                                const runDist = formatDistance(run.distance);
                                                return (
                                                    <div key={run.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                                                        <div className="flex items-center gap-3">
                                                            <div className="bg-blue-100 text-blue-600 p-3 rounded-xl">
                                                                <Icons.Activity size={20} />
                                                            </div>
                                                            <div>
                                                                <p className="text-sm font-bold text-gray-800">Running</p>
                                                                <p className="text-xs text-gray-400">{run.date} ‚Ä¢ {run.timestamp}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-lg font-black text-gray-800">{runDist.value} <span className="text-xs font-normal text-gray-500">{runDist.unit}</span></p>
                                                            <p className="text-xs font-mono text-gray-500">{formatTime(run.duration)}</p>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </main>

                    {/* Bottom Navigation Bar */}
                    <nav className="bg-white border-t border-gray-200 px-6 py-2 fixed bottom-0 w-full z-30 pb-safe">
                        <div className="flex justify-around items-center max-w-lg mx-auto">
                            <button 
                                onClick={() => setActiveTab('tracker')}
                                className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'tracker' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}
                            >
                                <Icons.Map size={24} className={activeTab === 'tracker' ? 'fill-current' : ''} />
                                <span className="text-[10px] font-bold mt-1">Tracker</span>
                            </button>
                            
                            <button 
                                onClick={() => setActiveTab('history')}
                                className={`flex flex-col items-center p-2 rounded-xl transition-colors ${activeTab === 'history' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}
                            >
                                <Icons.History size={24} />
                                <span className="text-[10px] font-bold mt-1">History</span>
                            </button>
                        </div>
                    </nav>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>